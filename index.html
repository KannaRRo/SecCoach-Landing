<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SecCoach ‚Äî Symulacja szkoleniowa</title>
<meta name="description" content="SecCoach ‚Äî symulacja szkoleniowa. Dane lokalne.">
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0b1326; --panel:#0f1a34; --card:#0e1630;
  --text:#e7f0fa; --muted:#a9b8c9;
  --accent:#18c4b8; --accent-2:#3ee6b9;
  --banner-h:48px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#081326,#0a1530);color:var(--text)}
/* Banner */
.sim-banner{
  position:fixed;left:0;right:0;top:0;z-index:1400;
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:10px 14px;background:linear-gradient(90deg,rgba(24,196,184,.12),rgba(62,230,185,.08));
  border-bottom:1px solid rgba(255,255,255,.06);font-size:14px;color:#dff6f3;
  backdrop-filter:saturate(120%) blur(6px);
}
/* Header (below banner) */
.site-header{position:sticky;top:var(--banner-h);z-index:1300;background:rgba(8,14,26,.9);border-bottom:1px solid rgba(255,255,255,.04)}
.wrap{max-width:1100px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:38px;height:38px;border-radius:8px;background:#081726;display:grid;place-items:center}
.brand b{font-size:16px}
nav{margin-left:auto;display:flex;gap:8px}
nav a{color:#dfeafb;text-decoration:none;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.03)}
nav a:hover{background:rgba(255,255,255,.03)}

/* Main content - padding-top will be set by JS to banner+header */
main{max-width:1100px;margin:0 auto;padding:20px 18px 36px}

/* Hero */
.hero{display:grid;gap:16px;grid-template-columns:1.1fr .9fr;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.04);border-radius:14px;padding:20px;box-shadow:0 8px 28px rgba(2,6,23,.45)}
@media(max-width:860px){.hero{grid-template-columns:1fr}}
.hero h1{margin:0 0 6px}
.hero p{margin:0;color:var(--muted)}

/* Clock */
.clock{display:grid;place-items:center;min-height:140px;border-radius:12px;background:linear-gradient(180deg,#081b30,#071427);border:1px solid rgba(255,255,255,.03)}
.clock time{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:48px;letter-spacing:1px;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;color:transparent}
.clock small{display:block;color:var(--muted);margin-top:8px}

/* Footer */
footer{max-width:1100px;margin:20px auto;padding:12px 18px;display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.03);border-radius:12px}
.counter{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
.pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.05);color:var(--muted)}
.btn{border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042422;border:none}

/* Report */
#report{max-width:1100px;margin:28px auto;padding:18px;background:rgba(255,255,255,.01);border:1px solid rgba(255,255,255,.03);border-radius:12px;display:none}
#report h2{text-align:center;margin-top:0;margin-bottom:12px}
.report-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.chart-box{background:#071530;border-radius:10px;padding:10px}
.chart-box canvas{display:block;width:100% !important;height:320px !important}
@media (min-width:900px){ .chart-box canvas{height:380px !important} }

/* Stats area */
.stats{display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:12px;color:var(--muted)}
.stats .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,12,.66);display:none;align-items:center;justify-content:center;z-index:1500;padding:16px}
.modal-backdrop.show{display:flex}
.modal{background:linear-gradient(180deg,#07122a,#061022);color:var(--text);border-radius:12px;padding:16px;max-width:720px;width:100%;box-shadow:0 12px 36px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,.04);max-height:90vh;overflow:auto}
.modal h2{margin-top:0}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.progress{height:12px;border-radius:8px;background:rgba(255,255,255,.04);overflow:hidden;margin:8px 0}
.progress .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .18s linear}

/* small helpers */
.muted{color:var(--muted)}
kbd{background:#071726;border-radius:6px;padding:2px 6px;font-family:ui-monospace;font-size:90%}
</style>
</head>
<body>
  <!-- Banner -->
  <div class="sim-banner" id="simBanner" role="status" aria-live="polite">
    <span style="display:inline-flex;align-items:center;gap:8px">
      <span class="pill" style="border:none;background:rgba(24,196,184,.12);color:#dff6f3">üß† Symulacja szkoleniowa</span>
      <span style="margin-left:6px">To bezpieczna strona edukacyjna ‚Äî <strong>nic z≈Çego siƒô nie dzieje</strong>. Dane lokalne.</span>
    </span>
  </div>

  <!-- Header -->
  <header class="site-header" role="banner" aria-label="G≈Ç√≥wne menu">
    <div class="wrap">
      <div class="brand"><div class="logo" aria-hidden="true"><svg viewBox="0 0 24 24" width="22" height="22"><path fill="#18c4b8" d="M12 2l7 20-7-4-7 4z"/></svg></div><b>SecCoach</b></div>
      <nav aria-label="Nawigacja">
        <a href="#" id="navEasy">O nas</a>
        <a href="#" id="navMedium">Us≈Çugi</a>
        <a href="#" id="navHard">Kontakt</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main id="mainContent">
    <section class="hero" aria-labelledby="t1">
      <div>
        <h1 id="t1">To jest <u>symulacja szkoleniowa</u> ‚Äî zachowaj czujno≈õƒá</h1>
        <p>Je≈õli wiadomo≈õƒá budzi wƒÖtpliwo≈õci: <strong>nie klikaj</strong> link√≥w, nie pobieraj za≈ÇƒÖcznik√≥w, sprawd≈∫ nadawcƒô i zg≈Ço≈õ do IT.</p>
      </div>
      <div class="clock" aria-live="polite" aria-atomic="true">
        <time id="clock">--:--:--</time>
        <small id="clockDate" class="muted"></small>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer role="contentinfo">
    <div class="counter" aria-live="polite"><span class="dot" aria-hidden="true"></span> Odwiedziny (lokalnie): <b id="visits">0</b> <span class="pill" style="margin-left:8px">Symulacja</span></div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" id="reportBtn" aria-controls="report">Raport (symulacja)</button>
      <a class="btn" href="https://kannarro.github.io/Technologie-aplikacji-mobilnych/login.html" target="_blank" rel="noopener">Przejd≈∫ do quizu</a>
    </div>

    <div class="muted" style="text-align:right">
      <div><strong>Autorzy:</strong> Kr√≥l Damian (54103) ‚Ä¢ Angelika Adamczewska (55914)</div>
      <div>Projekt in≈ºynierski ‚Äî Uniwersytet WSB Merito w Bydgoszczy ¬© 2025</div>
    </div>
  </footer>

  <!-- Report -->
  <section id="report" aria-labelledby="repTitle">
    <h2 id="repTitle">üìä Analiza zachowa≈Ñ u≈ºytkownik√≥w w symulacji phishingu</h2>
    <div class="report-grid" role="region" aria-label="Wykresy">
      <div class="chart-box"><canvas id="barChart" aria-label="Wykres s≈Çupkowy"></canvas></div>
      <div class="chart-box"><canvas id="lineChart" aria-label="Wykres liniowy"></canvas></div>
      <div class="chart-box"><canvas id="pieChart" aria-label="Wykres ko≈Çowy"></canvas></div>
      <div class="chart-box"><canvas id="decisionChart" aria-label="Wykres czasu decyzji"></canvas></div>
    </div>
    <div class="stats" aria-live="polite">
      <div class="row">
        <p>üîπ Odwiedziny: <b id="statVisits">0</b></p>
        <p>üîπ Zdarzenia: <b id="statEvents">0</b></p>
        <p>üîπ Ostatnia aktywno≈õƒá: <b id="statLast">‚Äî</b></p>
      </div>
      <div class="row" style="margin-top:6px">
        <p>‚è± ≈ör. czas decyzji: <b id="avgDecision">‚Äî</b></p>
        <p>‚è± Mediana: <b id="medDecision">‚Äî</b></p>
        <p>‚úÖ Zg≈Çoszenia: <b id="countReport">0</b></p>
        <p>‚ö†Ô∏è Instalacje: <b id="countInstall">0</b></p>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="exportCsv">Eksport CSV</button>
        <button class="btn" id="resetBtn">Reset symulacji</button>
      </div>
    </div>
  </section>

  <!-- Modal root -->
  <div class="modal-backdrop" id="modalRoot" aria-hidden="true"></div>

<script>
/* ---------------- Constants & helpers ---------------- */
const KEY_VIS = 'seccoach_visits';
const KEY_LOG = 'seccoach_log';

function logEvent(type, note){
  try{
    const arr = JSON.parse(localStorage.getItem(KEY_LOG) || '[]');
    arr.push({ type, when: new Date().toISOString(), ...(note ? { note } : {}) });
    localStorage.setItem(KEY_LOG, JSON.stringify(arr));
  }catch(e){ console.error('logEvent error', e); }
}
function fmtPL(date){ return date.toLocaleString('pl-PL'); }

/* ---------------- Banner/header offset ---------------- */
/* compute heights and set padding-top for main to avoid being covered */
function adjustLayoutPadding(){
  const banner = document.getElementById('simBanner');
  const header = document.querySelector('.site-header');
  const main = document.getElementById('mainContent');
  const bh = (banner && banner.offsetHeight) ? banner.offsetHeight : 0;
  const hh = (header && header.offsetHeight) ? header.offsetHeight : 0;
  // set CSS custom property so header can be sticky under banner
  document.documentElement.style.setProperty('--banner-h', bh + 'px');
  // set top padding for main = banner + header + 8px
  if(main) main.style.paddingTop = (bh + hh + 12) + 'px';
}
window.addEventListener('load', adjustLayoutPadding);
window.addEventListener('resize', adjustLayoutPadding);

/* ---------------- Clock ---------------- */
function updateClock(){
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const hh = pad(now.getHours()), mm = pad(now.getMinutes()), ss = pad(now.getSeconds());
  const timeEl = document.getElementById('clock');
  const dateEl = document.getElementById('clockDate');
  if(timeEl) timeEl.textContent = `${hh}:${mm}:${ss}`;
  if(dateEl) dateEl.textContent = now.toLocaleDateString('pl-PL', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}
updateClock();
setInterval(updateClock, 1000);

/* ---------------- Visits counter ---------------- */
(function(){
  try{
    let v = parseInt(localStorage.getItem(KEY_VIS) || '0', 10);
    if(isNaN(v)) v = 0;
    v += 1;
    localStorage.setItem(KEY_VIS, String(v));
    const visitsEl = document.getElementById('visits');
    if(visitsEl) visitsEl.textContent = v;
    logEvent('visit');
  }catch(e){ console.error('visits error', e); }
})();

/* ---------------- Modal utils ---------------- */
const modalRoot = document.getElementById('modalRoot');
let modalOpen = false;
function openModal(html, options = {}){
  modalRoot.innerHTML = `<div class="modal" role="dialog" aria-modal="true">${html}</div>`;
  modalRoot.classList.add('show');
  modalRoot.setAttribute('aria-hidden', 'false');
  modalOpen = true;
  // attach close-on-backdrop click
  modalRoot.onclick = (e) => { if(e.target === modalRoot) closeModal(); };
  // callback
  if(typeof options.onOpen === 'function'){
    try{ options.onOpen(modalRoot.querySelector('.modal')); }catch(e){ console.error(e); }
  }
}
function closeModal(){
  modalRoot.classList.remove('show');
  modalRoot.innerHTML = '';
  modalRoot.setAttribute('aria-hidden', 'true');
  modalOpen = false;
}

/* ---------------- Intro + Installer sequence ---------------- */
let pageLoadTime = Date.now();
let introShownAt = null;

function showIntro(){
  introShownAt = Date.now();
  openModal(`
    <h2>To jest strona szkoleniowa ‚Äî nic z≈Çego siƒô nie dzieje</h2>
    <p class="muted">To ƒáwiczenie szkoleniowe. Zwracaj uwagƒô na nadawcƒô, domenƒô oraz pro≈õby o has≈Ça czy p≈Çatno≈õci. Dane sƒÖ lokalne ‚Äî nic nie wysy≈Çamy.</p>
    <div class="actions"><button class="btn primary" id="introOk">Rozumiem</button></div>
  `, {
    onOpen: (m) => {
      const btn = m.querySelector('#introOk');
      if(btn) btn.addEventListener('click', () => {
        closeModal();
        scheduleInstaller();
      });
    }
  });
  logEvent('intro_shown');
}

function scheduleInstaller(){
  // want installer 8000 ms after page load; if already passed, show immediately
  const elapsed = Date.now() - pageLoadTime;
  const wait = Math.max(0, 8000 - elapsed);
  if(wait === 0) {
    // show immediately
    showInstaller();
  } else {
    setTimeout(()=> {
      // but only if modal isn't open
      if(!modalOpen) showInstaller();
    }, wait);
  }
}

function showInstaller(){
  openModal(`
    <span class="pill">Symulacja</span>
    <h2>Aktualizacja systemu ‚Äî wymagane dzia≈Çanie</h2>
    <p class="muted">Wykryto aktualizacjƒô. Czy chcesz zainstalowaƒá aktualizacjƒô teraz?</p>
    <div class="progress" aria-hidden="true"><div class="bar" id="installBar"></div></div>
    <small class="muted">Postƒôp: <b id="installPct">0%</b></small>
    <div class="actions">
      <button class="btn" id="reportIt">Zg≈Ço≈õ incydent do IT</button>
      <button class="btn primary" id="installBtn">Zainstaluj</button>
    </div>
  `, {
    onOpen: (m) => {
      const bar = m.querySelector('#installBar');
      const pct = m.querySelector('#installPct');
      const installBtn = m.querySelector('#installBtn');
      const reportBtn = m.querySelector('#reportIt');

      // installer simulation
      let progress = 0;
      let lastBucket = -1;
      const startTime = performance.now();
      const timer = setInterval(()=>{
        const step = Math.floor(Math.random()*7)+3; // 3..9
        progress = Math.min(100, progress + step);
        bar.style.width = progress + '%';
        pct.textContent = progress.toFixed(0) + '%';
        const bucket = Math.floor(progress / 20);
        if(bucket > lastBucket){
          lastBucket = bucket;
          logEvent('installer_progress', String(bucket * 20));
        }
        if(progress >= 100){
          clearInterval(timer);
        }
      }, 200);

      function finalize(type){
        clearInterval(timer);
        const ms = Math.round(performance.now() - startTime);
        logEvent(type, String(ms)); // note = ms
      }

      installBtn.addEventListener('click', ()=>{
        finalize('installer_install');
        closeModal();
        // feedback modal
        openModal(`<h2>B≈ÇƒÖd</h2><p class="muted">Instalowanie niezweryfikowanego oprogramowania jest niebezpieczne. Zawsze konsultuj z IT.</p><div class="actions"><button class="btn primary" id="ack">OK</button></div>`, {
          onOpen: (mm) => mm.querySelector('#ack').addEventListener('click', closeModal)
        });
      });

      reportBtn.addEventListener('click', ()=>{
        finalize('installer_report');
        closeModal();
        openModal(`<h2>≈öwietnie ‚Äî zg≈Çoszono incydent</h2><p class="muted">Zg≈Çoszenie podejrzanego komunikatu do IT to poprawne dzia≈Çanie.</p><div class="actions"><button class="btn primary" id="ok">OK</button></div>`, {
          onOpen: (mm) => mm.querySelector('#ok').addEventListener('click', closeModal)
        });
      });
    }
  });
  logEvent('installer_shown');
}

/* show intro immediately on load */
showIntro();

/* ---------------- Navigation educational modals ---------------- */
document.getElementById('navEasy').addEventListener('click', (e) => {
  e.preventDefault();
  openModal(`<h2>Poziom: ≈Çatwy</h2><ul class="muted"><li>Sprawd≈∫ adres nadawcy</li><li>Uwa≈ºaj na presjƒô czasu</li><li>Nie otwieraj niespodziewanych za≈ÇƒÖcznik√≥w</li></ul><div class="actions"><button class="btn primary" id="ok1">OK</button></div>`, {
    onOpen: (m) => m.querySelector('#ok1').addEventListener('click', () => { closeModal(); })
  });
  logEvent('nav_easy');
});
document.getElementById('navMedium').addEventListener('click', (e) => {
  e.preventDefault();
  openModal(`<h2>Poziom: ≈õredni</h2><p class="muted">Najed≈∫ na link i sprawd≈∫ pe≈Çny adres; zwr√≥ƒá uwagƒô na subdomeny i liter√≥wki.</p><div class="actions"><button class="btn primary" id="ok2">OK</button></div>`, {
    onOpen: (m) => m.querySelector('#ok2').addEventListener('click', () => { closeModal(); })
  });
  logEvent('nav_medium');
});
document.getElementById('navHard').addEventListener('click', (e) => {
  e.preventDefault();
  openModal(`<h2>Poziom: trudny</h2><ol class="muted"><li>Od≈ÇƒÖcz urzƒÖdzenie od sieci</li><li>Nie restartuj - zg≈Ço≈õ do IT</li><li>Zr√≥b zrzut ekranu i zanotuj czas</li></ol><div class="actions"><button class="btn primary" id="ok3">OK</button></div>`, {
    onOpen: (m) => m.querySelector('#ok3').addEventListener('click', () => { closeModal(); })
  });
  logEvent('nav_hard');
});

/* ---------------- Report & Charts ---------------- */
let charts = { bar: null, line: null, pie: null, decision: null };

function computeStats(){
  const logs = JSON.parse(localStorage.getItem(KEY_LOG) || '[]');
  const counts = { report:0, install:0, easy:0, medium:0, hard:0 };
  const decisionsMs = [];
  const byMinute = new Map();

  logs.forEach(r => {
    if(r.type === 'installer_report') counts.report++;
    if(r.type === 'installer_install') counts.install++;
    if(r.type === 'nav_easy') counts.easy++;
    if(r.type === 'nav_medium') counts.medium++;
    if(r.type === 'nav_hard') counts.hard++;
    if(r.note) decisionsMs.push(Number(r.note));
    // activity per minute
    const t = new Date(r.when);
    const key = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    byMinute.set(key, (byMinute.get(key) || 0) + 1);
  });

  const series = Array.from(byMinute.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
  decisionsMs.sort((a,b)=>a-b);
  const avg = decisionsMs.length ? decisionsMs.reduce((a,b)=>a+b,0)/decisionsMs.length : null;
  const med = decisionsMs.length ? (decisionsMs.length % 2 ? decisionsMs[(decisionsMs.length-1)/2] : (decisionsMs[decisionsMs.length/2-1] + decisionsMs[decisionsMs.length/2]) /2 ) : null;

  const buckets = { '0‚Äì2s':0, '2‚Äì5s':0, '5‚Äì10s':0, '10‚Äì20s':0, '20s+':0 };
  decisionsMs.forEach(ms => {
    const s = ms/1000;
    if(s <= 2) buckets['0‚Äì2s']++;
    else if(s <=5) buckets['2‚Äì5s']++;
    else if(s <=10) buckets['5‚Äì10s']++;
    else if(s <=20) buckets['10‚Äì20s']++;
    else buckets['20s+']++;
  });

  return {
    counts, series, total: logs.length, last: logs.length ? new Date(logs[logs.length-1].when) : null,
    avgSec: avg !== null ? (Math.round(avg/100)/10) : null,
    medSec: med !== null ? (Math.round(med/100)/10) : null,
    bucketLabels: Object.keys(buckets),
    bucketValues: Object.values(buckets)
  };
}

function destroyCharts(){
  Object.keys(charts).forEach(k => {
    if(charts[k]) { try{ charts[k].destroy(); }catch(e){} charts[k] = null; }
  });
}

function drawCharts(){
  try{
    const s = computeStats();

    // bar chart (actions)
    const barCtx = document.getElementById('barChart').getContext('2d');
    if(charts.bar) charts.bar.destroy();
    charts.bar = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ['Zg≈Ço≈õ do IT','Zainstaluj','≈Åatwy','≈öredni','Trudny'],
        datasets: [{ data: [s.counts.report, s.counts.install, s.counts.easy, s.counts.medium, s.counts.hard], backgroundColor:['#18c4b8','#f87171','#3ee6b9','#18c4b8','#0ea5a6'] }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#a9b8c9'}}, y:{beginAtZero:true, ticks:{color:'#a9b8c9'}} } }
    });

    // line chart (activity over time)
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    if(charts.line) charts.line.destroy();
    charts.line = new Chart(lineCtx, {
      type: 'line',
      data: { labels: s.series.map(x=>x[0]), datasets:[{ label:'Aktywno≈õƒá', data: s.series.map(x=>x[1]), borderColor:'#18c4b8', tension:0.3, fill:false }]},
      options: { responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#a9b8c9'}}, y:{ticks:{color:'#a9b8c9'}, beginAtZero:true}} }
    });

    // pie (share)
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    if(charts.pie) charts.pie.destroy();
    charts.pie = new Chart(pieCtx, {
      type: 'pie',
      data: { labels: ['Zg≈Ço≈õ','Zainstaluj','≈Åatwy','≈öredni','Trudny'], datasets:[{ data: [s.counts.report, s.counts.install, s.counts.easy, s.counts.medium, s.counts.hard], backgroundColor:['#18c4b8','#f87171','#3ee6b9','#18c4b8','#0ea5a6'] }]},
      options: { responsive:true, maintainAspectRatio:false }
    });

    // decision distribution
    const decCtx = document.getElementById('decisionChart').getContext('2d');
    if(charts.decision) charts.decision.destroy();
    charts.decision = new Chart(decCtx, {
      type: 'bar',
      data: { labels: s.bucketLabels, datasets: [{ data: s.bucketValues, backgroundColor:'#3ee6b9' }]},
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#a9b8c9'}}, y:{ticks:{color:'#a9b8c9'},beginAtZero:true}} }
    });

    // fill stats
    document.getElementById('statVisits').textContent = localStorage.getItem(KEY_VIS) || '0';
    document.getElementById('statEvents').textContent = s.total;
    document.getElementById('statLast').textContent = s.last ? fmtPL(s.last) : '‚Äî';
    document.getElementById('avgDecision').textContent = s.avgSec !== null ? (s.avgSec + ' s') : '‚Äî';
    document.getElementById('medDecision').textContent = s.medSec !== null ? (s.medSec + ' s') : '‚Äî';
    document.getElementById('countReport').textContent = s.counts.report;
    document.getElementById('countInstall').textContent = s.counts.install;

  }catch(err){ console.error('drawCharts error', err); }
}

/* Show report on button click */
document.getElementById('reportBtn').addEventListener('click', ()=>{
  const rep = document.getElementById('report');
  rep.style.display = 'block';
  rep.scrollIntoView({behavior:'smooth'});
  // draw after the container is visible and browser had a frame to compute sizes
  requestAnimationFrame(drawCharts);
});

/* resize handling: resize charts when window changes */
window.addEventListener('resize', ()=> {
  // Chart.js handles resizing, but we trigger redraw to be safe
  try{
    if(document.getElementById('report').style.display === 'block'){
      requestAnimationFrame(drawCharts);
    }
  }catch(e){ console.warn(e); }
});

/* ---------------- CSV export & reset ---------------- */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(KEY_LOG) || '[]');
  if(!arr.length){ alert('Brak danych do eksportu.'); return; }
  const headers = ['type','when','note'];
  const rows = arr.map(r => headers.map(h => `"${String(r[h] || '').replace(/"/g,'""')}"`).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'seccoach_raport.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(confirm('Wyczy≈õciƒá lokalne dane (licznik i logi)?')){ localStorage.removeItem(KEY_LOG); localStorage.removeItem(KEY_VIS); destroyCharts(); location.reload(); }
});

/* ---------------- small safety: catch uncaught errors ---------------- */
window.addEventListener('error', (ev) => {
  console.error('Window error:', ev.error || ev.message);
});

/* End of script */
</script>
</body>
</html>
