<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SecCoach â€” Symulacja szkoleniowa</title>
<meta name="description" content="Bezpieczna strona edukacyjna â€” nic zÅ‚ego siÄ™ nie dzieje.">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1326; --panel:#0f1a34; --card:#0e1630;
  --text:#e7f0fa; --muted:#a9b8c9;
  --accent:#18c4b8; --accent-2:#3ee6b9; --danger:#ef4444; --warn:#f59e0b;
  --shadow:0 10px 30px rgba(2,6,23,.45);
  --banner-h: 40px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#081326,#0a1530); color:var(--text);
  padding-bottom: env(safe-area-inset-bottom);
}
h1,h2,h3{color:var(--text)}

/* Sticky banner */
.sim-banner{
  position:fixed; left:0; right:0; top:0; z-index:1200;
  display:flex; align-items:center; justify-content:center; gap:8px;
  padding:8px 12px;
  background:linear-gradient(90deg, rgba(24,196,184,.15), rgba(62,230,185,.15));
  border-bottom:1px solid rgba(255,255,255,.12);
  color:#dff6f3; font-size:14px; line-height:1.3;
  backdrop-filter:saturate(140%) blur(6px);
}
.sim-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(24,196,184,.5);background:rgba(24,196,184,.12);font-size:12px}

/* Header */
.site-header{
  position:sticky; top:var(--banner-h); z-index:1000;
  background:rgba(10,20,40,.85);
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter:saturate(140%) blur(8px);
}
.wrap{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:10px;white-space:nowrap}
.logo{width:38px;height:38px;border-radius:9px;background:#0a1a33;display:grid;place-items:center}
.logo svg{width:22px;height:22px}
.brand b{font-size:16px}
nav{margin-left:auto;display:flex;gap:10px;align-items:center}
nav a{color:#dfeafb;text-decoration:none;font-size:14px;opacity:.9;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.06)}
nav a:hover{opacity:1;background:rgba(255,255,255,.05)}

/* Main */
main{max-width:1100px;margin:0 auto;padding:calc(18px + var(--banner-h)) 18px 18px}
.hero{
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px; padding:22px; box-shadow:var(--shadow);
  display:grid; gap:16px; grid-template-columns:1.1fr .9fr;
}
.hero h1{margin:0 0 8px; font-size:24px}
.hero p{margin:0; color:var(--muted)}
@media (max-width:860px){ .hero{grid-template-columns:1fr} }

/* Clock */
.clock{
  display:grid; place-items:center; min-height:160px;
  background:radial-gradient(110% 110% at 50% 0%, #0b223f 0%, #0a1730 60%);
  border:1px solid rgba(255,255,255,.06); border-radius:16px;
}
.clock time{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:52px; letter-spacing:2px;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow:0 0 22px rgba(24,196,184,.25);
}
.clock small{display:block;color:var(--muted);margin-top:6px}

/* Footer */
footer{
  max-width:1100px;margin:16px auto 24px; padding:12px 18px;
  display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap;
  background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:14px;
}
.counter{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
.pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);color:var(--muted)}
.muted{color:var(--muted)}
.btn{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#042422; border:none}

/* Modals */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(5,10,20,.65);
  display:none; align-items:center; justify-content:center; z-index:2000; padding:16px;
  overflow:auto;
}
.modal-backdrop.show{display:flex}
.modal{
  background:linear-gradient(180deg,#0e1b35,#0b162c); color:var(--text);
  border:1px solid rgba(255,255,255,.08); border-radius:16px; max-width:760px; width:100%;
  box-shadow:var(--shadow); padding:18px; max-height:min(90vh,820px); overflow:auto;
}
.modal h2{margin:0 0 8px; font-size:20px}
.modal p{margin:8px 0 0}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;position:sticky;bottom:0;background:linear-gradient(180deg,rgba(14,27,53,0),rgba(14,27,53,.9));padding-top:10px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:#dfeafb;margin-right:8px}
.badge.warn{border-color:rgba(245,158,11,.4); color:#ffd58a}
.badge.danger{border-color:rgba(239,68,68,.4); color:#ffaaaa}

/* Installer progress bar */
.progress{height:12px;border-radius:8px;background:rgba(255,255,255,.08);overflow:hidden;margin:10px 0}
.progress .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .2s linear}

/* Report section */
#report{max-width:1100px;margin:40px auto;padding:24px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:16px;display:none}
#report h2{text-align:center;margin:0 0 10px}
.report-grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));}

/* KLUCZ: pudeÅ‚ko z wymuszonÄ… wysokoÅ›ciÄ…, canvas wypeÅ‚nia 100% */
.chart-box{
  width:100%;
  height:clamp(260px, 45vw, 420px);
  background:#0d1c38;
  border-radius:12px;
  padding:10px;
  display:block;
}
.chart-box > canvas{
  width:100% !important;
  height:100% !important;
  display:block;
}

.stats{margin-top:20px;display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;}
.stats .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
</style>
</head>
<body>
<div class="sim-banner" id="simBanner">
  <span class="sim-badge">ğŸ§  <b>Symulacja szkoleniowa</b></span>
  <span>To bezpieczna strona edukacyjna â€” <b>nic zÅ‚ego siÄ™ nie dzieje</b>. Dane zostajÄ… lokalnie.</span>
</div>

<header class="site-header" role="banner">
  <div class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path fill="#18c4b8" d="M12 2l7 20-7-4-7 4z"/></svg>
      </div>
      <b>SecCoach</b><span class="muted">â€¢ Edukacja</span>
    </div>
    <nav id="mainnav" aria-label="GÅ‚Ã³wne menu">
      <a href="#" id="navEasy">O nas</a>
      <a href="#" id="navMedium">UsÅ‚ugi</a>
      <a href="#" id="navHard">Kontakt</a>
    </nav>
  </div>
</header>

<main>
  <section class="hero" aria-labelledby="t1">
    <div>
      <h1 id="t1">To jest <u>symulacja szkoleniowa</u> â€” zachowaj czujnoÅ›Ä‡</h1>
      <p>JeÅ›li wiadomoÅ›Ä‡ budzi wÄ…tpliwoÅ›ci: <b>nie klikaj</b> linkÃ³w, nie pobieraj zaÅ‚Ä…cznikÃ³w, sprawdÅº nadawcÄ™ i zgÅ‚oÅ› do IT.</p>
    </div>
    <div class="clock" aria-live="polite">
      <time id="clock">--:--:--</time>
      <small id="clockDate" class="muted"></small>
    </div>
  </section>
</main>

<footer role="contentinfo">
  <div class="counter" aria-live="polite">
    <span class="dot" aria-hidden="true"></span>
    <span>Odwiedziny (lokalnie): <b id="visits">0</b></span>
    <span class="pill">Symulacja</span>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn primary" id="reportBtn">Raport (symulacja)</button>
    <a class="btn" href="https://kannarro.github.io/Technologie-aplikacji-mobilnych/login.html" target="_blank" rel="noopener">PrzejdÅº do quizu</a>
  </div>
  <div class="muted" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <span class="pill">Autorzy</span>
    <span>KrÃ³l Damian (54103)</span><span>â€¢</span><span>Angelika Adamczewska (55914)</span>
    <span>â€¢</span><b>Projekt inÅ¼ynierski</b> Uniwersytetu WSB Merito w Bydgoszczy Â© 2025
  </div>
</footer>

<section id="report" aria-labelledby="repTitle">
  <h2 id="repTitle">ğŸ“Š Analiza zachowaÅ„ uÅ¼ytkownikÃ³w w symulacji phishingu</h2>
  <div class="report-grid">
    <div class="chart-box"><canvas id="barChart" aria-label="KlikniÄ™cia wg kategorii" role="img"></canvas></div>
    <div class="chart-box"><canvas id="lineChart" aria-label="AktywnoÅ›Ä‡ w czasie" role="img"></canvas></div>
    <div class="chart-box"><canvas id="pieChart" aria-label="UdziaÅ‚ procentowy akcji" role="img"></canvas></div>
    <div class="chart-box"><canvas id="decisionChart" aria-label="RozkÅ‚ad czasu decyzji" role="img"></canvas></div>
  </div>
  <div class="stats">
    <div class="row">
      <p>ğŸ”¹ Odwiedziny: <b id="statVisits">0</b></p>
      <p>ğŸ”¹ Zdarzenia: <b id="statEvents">0</b></p>
      <p>ğŸ”¹ Ostatnia aktywnoÅ›Ä‡: <b id="statLast">â€”</b></p>
    </div>
    <div class="row">
      <p>â±ï¸ Åšredni czas decyzji: <b id="avgDecision">â€”</b></p>
      <p>â±ï¸ Mediana czasu decyzji: <b id="medDecision">â€”</b></p>
      <p>âœ… ZgÅ‚oszenia do IT: <b id="countReport">0</b></p>
      <p>âš ï¸ Instalacje: <b id="countInstall">0</b></p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
      <button class="btn" id="exportCsv">Eksport CSV</button>
      <button class="btn" id="resetBtn">Reset symulacji</button>
    </div>
  </div>
</section>

<div class="modal-backdrop" id="modalRoot" aria-modal="true" role="dialog" aria-live="polite"></div>

<script>
/* ---------- Helpers & constants ---------- */
const KEY_VIS='seccoach_visits';
const KEY_LOG='seccoach_log'; // {type, when, note?}
function logEvent(type, note){
  const arr = JSON.parse(localStorage.getItem(KEY_LOG) || '[]');
  arr.push({ type, when: new Date().toISOString(), ...(note?{note}: {}) });
  localStorage.setItem(KEY_LOG, JSON.stringify(arr));
}
function fmtPL(dt){ return dt.toLocaleString('pl-PL'); }

/* ---------- Banner offset ---------- */
(function(){
  const b=document.getElementById('simBanner');
  function setH(){ document.documentElement.style.setProperty('--banner-h',(b?b.offsetHeight:0)+'px'); }
  setH(); addEventListener('resize', setH);
})();

/* ---------- Clock ---------- */
function updateClock(){
  const now=new Date(), pad=n=>String(n).padStart(2,'0');
  document.getElementById('clock').textContent=`${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  document.getElementById('clockDate').textContent=now.toLocaleDateString('pl-PL',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
}
updateClock(); setInterval(updateClock,1000);

/* ---------- Visits counter ---------- */
(function(){
  let v=parseInt(localStorage.getItem(KEY_VIS)||'0',10); if(isNaN(v)) v=0; v++;
  localStorage.setItem(KEY_VIS, String(v));
  document.getElementById('visits').textContent=v;
  logEvent('visit');
})();

/* ---------- Modal utils ---------- */
const modalRoot=document.getElementById('modalRoot');
let modalOpen=false;
function openModal(html, onOpen){
  modalRoot.innerHTML = `<div class="modal">${html}</div>`;
  modalRoot.classList.add('show'); modalOpen=true;
  if(typeof onOpen==='function') onOpen(modalRoot.querySelector('.modal'));
  modalRoot.onclick=(e)=>{ if(e.target===modalRoot) closeModal(); };
}
function closeModal(){
  modalRoot.classList.remove('show'); modalRoot.innerHTML=''; modalOpen=false;
}

/* ---------- Intro modal ---------- */
function showIntro(){
  openModal(`
    <h2>To jest strona szkoleniowa â€” nic zÅ‚ego siÄ™ nie dzieje</h2>
    <p class="muted">
      W ramach Ä‡wiczeÅ„ uczysz siÄ™ bezpiecznych zachowaÅ„ online.<br>
      Zawsze weryfikuj nadawcÄ™, nie instaluj plikÃ³w z maila i zgÅ‚aszaj podejrzane sytuacje do IT.
    </p>
    <div class="actions">
      <button class="btn primary" id="introOk">Rozumiem</button>
    </div>
  `, (modal)=> modal.querySelector('#introOk').addEventListener('click', closeModal));
  logEvent('intro_shown');
}

/* ---------- Installer simulation (progress + decision timer) ---------- */
let installerTimer=null, installerProgress=0, lastLoggedBucket=-1, installerStart=0;
function showInstaller(){
  openModal(`
    <span class="badge warn">Symulacja</span>
    <h2>Aktualizacja systemu â€” wymagane dziaÅ‚anie</h2>
    <p class="muted">Komputer wymaga natychmiastowej instalacji pakietu bezpieczeÅ„stwa. Czy chcesz kontynuowaÄ‡?</p>
    <div class="progress" aria-label="PostÄ™p instalacji (symulacja)">
      <div class="bar" id="installBar" style="width:0%"></div>
    </div>
    <small class="muted">PostÄ™p: <b id="installPct">0%</b></small>
    <ul class="muted" style="margin-left:18px">
      <li>Å¹rÃ³dÅ‚o: <b>niezweryfikowane</b> (to tylko test szkoleniowy).</li>
      <li>Dobra praktyka: instaluj aktualizacje wyÅ‚Ä…cznie z oficjalnych ÅºrÃ³deÅ‚.</li>
    </ul>
    <div class="actions">
      <button class="btn" id="reportIt">ZgÅ‚oÅ› incydent do IT</button>
      <button class="btn primary" id="install">Zainstaluj</button>
    </div>
  `,(modal)=>{
    const bar = modal.querySelector('#installBar');
    const pct = modal.querySelector('#installPct');
    installerProgress = 0; lastLoggedBucket = -1;
    installerStart = performance.now();

    installerTimer = setInterval(()=>{
      installerProgress += Math.floor(Math.random()*7)+3; // 3â€“9% co 200ms
      if(installerProgress>100) installerProgress=100;
      bar.style.width = installerProgress+'%';
      pct.textContent = installerProgress+'%';
      const bucket = Math.floor(installerProgress/20);
      if(bucket>lastLoggedBucket){ logEvent('installer_progress', String(bucket*20)); lastLoggedBucket = bucket; }
      if(installerProgress===100){ clearInterval(installerTimer); installerTimer=null; }
    }, 200);

    function finalizeDecision(type){
      if(installerTimer){ clearInterval(installerTimer); installerTimer=null; }
      const ms = performance.now() - installerStart;
      logEvent(type, String(Math.round(ms)));
      closeModal();
    }

    modal.querySelector('#install').addEventListener('click', ()=>{
      finalizeDecision('installer_install');
      openModal(`
        <span class="badge danger">BÅ‚Ä…d</span>
        <h2>To nie byÅ‚ dobry wybÃ³r</h2>
        <p class="muted">Instalowanie oprogramowania z nieznanego ÅºrÃ³dÅ‚a niesie ryzyko. Zawsze weryfikuj nadawcÄ™ i zgÅ‚aszaj wÄ…tpliwoÅ›ci do IT.</p>
        <div class="actions"><button class="btn primary" id="ack">OK</button></div>
      `,(m)=>m.querySelector('#ack').addEventListener('click', closeModal));
    });

    modal.querySelector('#reportIt').addEventListener('click', ()=>{
      finalizeDecision('installer_report');
      openModal(`
        <span class="badge">Gratulacje</span>
        <h2>Åšwietnie â€” to wÅ‚aÅ›ciwa reakcja</h2>
        <p class="muted">ZgÅ‚aszanie podejrzanych komunikatÃ³w do IT to najlepsza praktyka. Tak trzymaÄ‡!</p>
        <div class="actions"><button class="btn primary" id="ok">OK</button></div>
      `,(m)=>m.querySelector('#ok').addEventListener('click', closeModal));
    });
  });
  logEvent('installer_shown');
}

/* ---------- Sequence: intro now, installer +8s ---------- */
let secondModalDue=false;
showIntro();
setTimeout(()=>{ secondModalDue=true; if(!modalOpen) showInstaller(); }, 8000);
const modalObserver=new MutationObserver(()=>{ if(!modalOpen && secondModalDue){ showInstaller(); modalObserver.disconnect(); }});
modalObserver.observe(modalRoot,{attributes:true,attributeFilter:['class']});

/* ---------- Educational modals ---------- */
function showEasy(){ openModal(`
  <span class="badge">Poziom: Å‚atwy</span>
  <h2>Jak rozpoznaÄ‡ podejrzanego maila?</h2>
  <ul class="muted" style="margin-left:18px">
    <li>SprawdÅº <b>adres nadawcy</b> (literÃ³wki, dziwne domeny).</li>
    <li>UwaÅ¼aj na <b>presjÄ™ czasu</b> (â€pilneâ€, â€natychmiastâ€).</li>
    <li>Nie klikaj linkÃ³w, ktÃ³rych siÄ™ nie spodziewasz.</li>
  </ul>
  <div class="actions"><button class="btn primary" id="ok">OK</button></div>
`,(m)=>m.querySelector('#ok').addEventListener('click', closeModal)); logEvent('nav_easy');}
function showMedium(){ openModal(`
  <span class="badge">Poziom: Å›redni</span>
  <h2>Link wyglÄ…da poprawnie? SprawdÅº, dokÄ…d naprawdÄ™ prowadzi</h2>
  <p class="muted">NajedÅº na link i <b>odczytaj peÅ‚ny adres</b>. ZwrÃ³Ä‡ uwagÄ™ na:</p>
  <ul class="muted" style="margin-left:18px">
    <li>subdomeny udajÄ…ce markÄ™ (np. <code>login.bank.example.com</code> vs <code>bank.com</code>),</li>
    <li>dziwne rozszerzenia plikÃ³w (<code>.exe</code>, <code>.js</code>, <code>.scr</code>),</li>
    <li>HTTPS â‰  wiarygodnoÅ›Ä‡ nadawcy.</li>
  </ul>
  <div class="actions"><button class="btn primary" id="ok">OK</button></div>
`,(m)=>m.querySelector('#ok').addEventListener('click', closeModal)); logEvent('nav_medium');}
function showHard(){ openModal(`
  <span class="badge">Poziom: trudny</span>
  <h2>Co zrobiÄ‡ po klikniÄ™ciu w zÅ‚oÅ›liwy link?</h2>
  <ol class="muted" style="margin-left:18px">
    <li><b>OdÅ‚Ä…cz</b> urzÄ…dzenie od sieci (Wi-Fi/kabel).</li>
    <li><b>Nie</b> restartuj â€” przekaÅ¼ do analizy IT.</li>
    <li>ZrÃ³b zrzut ekranu i <b>zanotuj godzinÄ™</b>.</li>
    <li><b>Natychmiast zgÅ‚oÅ›</b> incydent do IT / CSIRT.</li>
  </ol>
  <div class="actions"><button class="btn primary" id="ok">ZapamiÄ™tam</button></div>
`,(m)=>m.querySelector('#ok').addEventListener('click', closeModal)); logEvent('nav_hard');}
document.getElementById('navEasy').addEventListener('click',(e)=>{e.preventDefault(); showEasy();});
document.getElementById('navMedium').addEventListener('click',(e)=>{e.preventDefault(); showMedium();});
document.getElementById('navHard').addEventListener('click',(e)=>{e.preventDefault(); showHard();});

/* ---------- Report (Chart.js) ---------- */
let barChart,lineChart,pieChart,decisionChart;

function computeStats(){
  const logs = JSON.parse(localStorage.getItem(KEY_LOG) || '[]');

  const counts = { report:0, install:0, easy:0, medium:0, hard:0 };
  const decisions = []; // ms

  logs.forEach(r=>{
    if(r.type==='installer_report'){ counts.report++; if(r.note) decisions.push(Number(r.note)); }
    else if(r.type==='installer_install'){ counts.install++; if(r.note) decisions.push(Number(r.note)); }
    else if(r.type==='nav_easy') counts.easy++;
    else if(r.type==='nav_medium') counts.medium++;
    else if(r.type==='nav_hard') counts.hard++;
  });

  const byMinute = new Map();
  logs.forEach(r=>{
    const t = new Date(r.when);
    const key = t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0')+
                ' '+String(t.getHours()).padStart(2,'0')+':'+String(t.getMinutes()).padStart(2,'0');
    byMinute.set(key,(byMinute.get(key)||0)+1);
  });
  const series = Array.from(byMinute.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
  const last = logs.length ? fmtPL(new Date(logs[logs.length-1].when)) : 'â€”';

  decisions.sort((a,b)=>a-b);
  const avg = decisions.length ? decisions.reduce((a,b)=>a+b,0)/decisions.length : NaN;
  const med = decisions.length ? (decisions.length%2 ? decisions[(decisions.length-1)/2] : (decisions[decisions.length/2-1]+decisions[decisions.length/2])/2) : NaN;

  const buckets = { '0â€“2s':0, '2â€“5s':0, '5â€“10s':0, '10â€“20s':0, '20s+':0 };
  decisions.forEach(ms=>{
    const s = ms/1000;
    if(s<=2) buckets['0â€“2s']++;
    else if(s<=5) buckets['2â€“5s']++;
    else if(s<=10) buckets['5â€“10s']++;
    else if(s<=20) buckets['10â€“20s']++;
    else buckets['20s+']++;
  });

  return {
    counts, series,
    total: logs.length, last,
    avgSec: isNaN(avg)? null : Math.round(avg/100)/10,
    medSec: isNaN(med)? null : Math.round(med/100)/10,
    bucketLabels: Object.keys(buckets),
    bucketValues: Object.values(buckets)
  };
}

function drawCharts(){
  const s = computeStats();

  const commonOpts = {responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#a9b8c9'}}},
    scales:{x:{ticks:{color:'#a9b8c9'}},y:{ticks:{color:'#a9b8c9'},beginAtZero:true}}};

  // bar
  const barCtx = document.getElementById('barChart').getContext('2d');
  if(barChart) barChart.destroy();
  barChart = new Chart(barCtx,{
    type:'bar',
    data:{ labels:['ZgÅ‚oÅ› do IT','Zainstaluj','Åatwy','Åšredni','Trudny'],
           datasets:[{ label:'Liczba zdarzeÅ„', data:[s.counts.report,s.counts.install,s.counts.easy,s.counts.medium,s.counts.hard],
                       backgroundColor:['#18c4b8','#f87171','#3ee6b9','#18c4b8','#0ea5a6'] }]},
    options:{...commonOpts, plugins:{legend:{display:false}}}
  });

  // line
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(lineCtx,{
    type:'line',
    data:{ labels:s.series.map(x=>x[0]), datasets:[{ label:'AktywnoÅ›Ä‡ w czasie', data:s.series.map(x=>x[1]), borderColor:'#18c4b8', tension:.3 }]},
    options:commonOpts
  });

  // pie
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx,{
    type:'pie',
    data:{ labels:['ZgÅ‚oÅ› do IT','Zainstaluj','Åatwy','Åšredni','Trudny'],
           datasets:[{ data:[s.counts.report,s.counts.install,s.counts.easy,s.counts.medium,s.counts.hard],
                       backgroundColor:['#18c4b8','#f87171','#3ee6b9','#18c4b8','#0ea5a6'] }]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a9b8c9'}}}}
  });

  // decision distribution
  const decCtx = document.getElementById('decisionChart').getContext('2d');
  if(decisionChart) decisionChart.destroy();
  decisionChart = new Chart(decCtx,{
    type:'bar',
    data:{ labels:s.bucketLabels, datasets:[{ label:'Czas decyzji (liczba osÃ³b)', data:s.bucketValues, backgroundColor:'#3ee6b9' }] },
    options:{...commonOpts, plugins:{legend:{display:false}}}
  });

  // stats
  document.getElementById('statVisits').textContent = localStorage.getItem(KEY_VIS) || '0';
  document.getElementById('statEvents').textContent = String(s.total);
  document.getElementById('statLast').textContent   = s.last;
  document.getElementById('avgDecision').textContent = s.avgSec!=null ? (s.avgSec.toFixed(1)+' s') : 'â€”';
  document.getElementById('medDecision').textContent = s.medSec!=null ? (s.medSec.toFixed(1)+' s') : 'â€”';
  document.getElementById('countReport').textContent = s.counts.report;
  document.getElementById('countInstall').textContent = s.counts.install;
}

/* pokaÅ¼ raport i RYSUJ po tym, jak element juÅ¼ ma rozmiar */
document.getElementById('reportBtn').addEventListener('click', ()=>{
  const sec = document.getElementById('report');
  sec.style.display='block';
  sec.scrollIntoView({behavior:'smooth'});
  requestAnimationFrame(drawCharts);
});

/* re-render przy zmianie rozmiaru (np. rotacja telefonu) */
const ro = new ResizeObserver(()=>{
  if(document.getElementById('report').style.display==='block'){
    requestAnimationFrame(drawCharts);
  }
});
ro.observe(document.body);

/* Export CSV + Reset */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(KEY_LOG)||'[]');
  if(!arr.length){ alert('Brak danych do eksportu.'); return; }
  const headers = ['type','when','note'];
  const rows = arr.map(r => headers.map(h => `"${String(r[h]??'').replace(/"/g,'""')}"`).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'seccoach-raport-symulacja.csv'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(confirm('WyczyÅ›ciÄ‡ lokalne dane (licznik i logi)?')){ localStorage.removeItem(KEY_LOG); localStorage.removeItem(KEY_VIS); location.reload(); }
});

/* Kickoff */
let secondModalDue=false;
showIntro();
setTimeout(()=>{ secondModalDue=true; if(!modalOpen) showInstaller(); }, 8000);
const modalObserver=new MutationObserver(()=>{ if(!modalOpen && secondModalDue){ showInstaller(); modalObserver.disconnect(); }});
modalObserver.observe(modalRoot,{attributes:true,attributeFilter:['class']});
</script>
</body>
</html>
